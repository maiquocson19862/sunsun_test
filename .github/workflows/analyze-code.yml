name: Analyze Code with ChatGPT

on:
  push:
    branches:
      - main  # Hoặc nhánh bạn muốn theo dõi
  pull_request:

jobs:
  analyze_code:
    runs-on: ubuntu-latest

    steps:
      - name: Check if analysis is enabled
        run: |
          ENABLE_ANALYSIS="${{ secrets.ENABLE_ANALYSIS }}"
          echo "ENABLE_ANALYSIS=$ENABLE_ANALYSIS"
          if [ "$ENABLE_ANALYSIS" != "true" ]; then
            echo "Code analysis is disabled. Exiting..."
            exit 0
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40

      - name: Read changed code
        id: read-code
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.all_modified_files }}"
          CODE=""
          for FILE in $CHANGED_FILES; do
            if [[ "$FILE" =~ \.(php|js|py|java|html|css)$ ]]; then
              CODE+="$(cat "$FILE")\n\n"
            fi
          done
          echo "code<<EOF" >> $GITHUB_ENV
          echo "$CODE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Analyze code with ChatGPT
        id: chatgpt
        run: |
          echo "Analyze code with ChatGPT start"
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4",
              "messages": [{"role": "user", "content": "'"$code"'"}]
            }')
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          echo "analysis<<EOF" >> $GITHUB_ENV
          echo "$ANALYSIS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send email with analysis
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ChatGPT Code Analysis"
          to: "your_email@example.com"
          from: "GitHub Actions"
          body: "${{ env.analysis }}"